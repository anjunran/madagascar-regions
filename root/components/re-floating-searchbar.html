<div class="w3-modal-content w3-animate-opacity w3-round-large w3-card w3-margin-bottom"
    style="width: 90%; overflow-x: hidden;">
    <div class="w3-container">
        <span onclick="w3_searchBar_close()" class="w3-button w3-display-topright">&times;</span>

        <div class="search-header w3-border-bottom">
            <h2><i class="fas fa-sitemap"></i> Hierarchical Search</h2>
            <p class="subtitle w3-margin-bottom">Search any administrative division and see its complete hierarchical
                context</p>
        </div>

        <div class="w3-row w3-animate-left" id="searchSlide">
            <div class="w3-third w3-margin-bottom"
                x-show="!hierarchicalSearchTerm || hierarchicalSearchTerm.length < 2">
                <!-- Initial State / Search Suggestions -->
                <div class="search-suggestions">
                    <div class="suggestions-header">
                        <h3><i class="fas fa-lightbulb"></i> Try searching for:</h3>
                        <p>Examples of administrative divisions at different levels</p>
                    </div>
                    <div class="suggestions-grid">
                        <div class="suggestion-card"
                            @click="hierarchicalSearchTerm = 'Antananarivo'; performHierarchicalSearch()">
                            <div class="suggestion-badge region-badge">REGION</div>
                            <div class="suggestion-name">Antananarivo</div>
                            <div class="suggestion-desc">Capital region with 8 districts</div>
                        </div>
                        <div class="suggestion-card"
                            @click="hierarchicalSearchTerm = 'Analamanga'; performHierarchicalSearch()">
                            <div class="suggestion-badge region-badge">REGION</div>
                            <div class="suggestion-name">Analamanga</div>
                            <div class="suggestion-desc">Central region of Madagascar</div>
                        </div>
                        <div class="suggestion-card"
                            @click="hierarchicalSearchTerm = 'Ambohidratrimo'; performHierarchicalSearch()">
                            <div class="suggestion-badge district-badge">DISTRICT</div>
                            <div class="suggestion-name">Ambohidratrimo</div>
                            <div class="suggestion-desc">District with 17 communes</div>
                        </div>
                        <div class="suggestion-card"
                            @click="hierarchicalSearchTerm = 'Antananarivo Atsimondrano';performHierarchicalSearch()">
                            <div class="suggestion-badge commune-badge">COMMUNE</div>
                            <div class="suggestion-name">Antananarivo Atsimondrano</div>
                            <div class="suggestion-desc">Southern commune of the capital</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="w3-rest">
                <div class="search-input-container w3-border-bottom">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="hierarchical-search-input" class="hierarchical-search-input"
                            placeholder="Search for region, district, commune, or fokontany..."
                            x-model="hierarchicalSearchTerm" @input.debounce.1000ms="performHierarchicalSearch()">
                        <button x-show="hierarchicalSearchTerm" @click="clearHierarchicalSearch()"
                            class="clear-search-btn" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="search-filters w3-margin-bottom">
                        <div class="filter-options">
                            <label class="filter-option active" data-filter="all">
                                <input type="radio" name="searchFilter" value="all" checked>
                                <span>All</span>
                            </label>
                            <label class="filter-option" data-filter="region">
                                <input type="radio" name="searchFilter" value="region">
                                <span>Regions</span>
                            </label>
                            <label class="filter-option" data-filter="district">
                                <input type="radio" name="searchFilter" value="district">
                                <span>Districts</span>
                            </label>
                            <label class="filter-option" data-filter="commune">
                                <input type="radio" name="searchFilter" value="commune">
                                <span>Communes</span>
                            </label>
                            <label class="filter-option" data-filter="fokontany">
                                <input type="radio" name="searchFilter" value="fokontany">
                                <span>Fokontany</span>
                            </label>
                        </div>
                    </div>

                    <div class="search-container active" id="hierarchical-search">
                        <!-- Search Results -->
                        <div x-show="hierarchicalSearchTerm && hierarchicalSearchTerm.length >= 2 && hierarchicalSearchResults.results.length > 0"
                            class="search-results-container">
                            <div class="results-header">
                                <h3>
                                    <i class="fas fa-search-location"></i>
                                    Search Results:
                                    <span class="search-term" x-text="hierarchicalSearchTerm"></span>
                                    <span class="results-count"
                                        x-text="`(${hierarchicalSearchResults.totalMatches} matches found)`"></span>
                                </h3>
                                <div class="results-stats">
                                    <span class="stat-item" x-show="hierarchicalSearchResults.filteredBy">
                                        <i class="fas fa-filter"></i>
                                        Filter: <span x-text="hierarchicalSearchResults.filteredBy"></span>
                                    </span>
                                    <span class="stat-item">
                                        <i class="far fa-clock"></i>
                                        Found in <span x-text="hierarchicalSearchResults.searchTime"></span>ms
                                    </span>
                                </div>
                            </div>

                            <div class="results-list">
                                <template x-for="(result, index) in hierarchicalSearchResults.results" :key="result.id">
                                    <div class="result-item"
                                        :class="['result-type-' + result?.type, { 'exact-match': result.exactMatch }]"
                                        @click="selectHierarchicalResult(result); searchSlide.next()">
                                        <div class="result-header">
                                            <div class="result-type-badge" :class="result?.type + '-badge'">
                                                <span x-text="result?.type.toUpperCase()"></span>
                                            </div>
                                            <div class="result-name" x-text="result?.name"></div>
                                            <div class="result-actions">
                                                <button class="result-action-btn" title="View details">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="result-details">
                                            <div class="result-hierarchy">
                                                <i class="fas fa-project-diagram"></i>
                                                <span x-show="result?.hierarchyPath.length > 0">
                                                    Part of:
                                                    <span
                                                        x-text="result?.hierarchyPath.map(p => p?.name).join(' â†’ ')"></span>
                                                </span>
                                                <span x-show="result?.hierarchyPath.length === 0">
                                                    Top-level administrative division
                                                </span>
                                            </div>

                                            <div class="result-stats">
                                                <template x-if="result?.type === 'region'">
                                                    <div class="stats-grid">
                                                        <div class="stat">
                                                            <i class="fas fa-layer-group"></i>
                                                            <span x-text="result.childrenCount.districts || 0"></span>
                                                            <span>districts</span>
                                                        </div>
                                                        <div class="stat">
                                                            <i class="fas fa-building"></i>
                                                            <span x-text="result.childrenCount.communes || 0"></span>
                                                            <span>communes</span>
                                                        </div>
                                                        <div class="stat">
                                                            <i class="fas fa-home"></i>
                                                            <span x-text="result.childrenCount.fokontany || 0"></span>
                                                            <span>fokontany</span>
                                                        </div>
                                                    </div>
                                                </template>

                                                <template x-if="result?.type === 'district'">
                                                    <div class="stats-grid">
                                                        <div class="stat">
                                                            <i class="fas fa-building"></i>
                                                            <span x-text="result.childrenCount.communes || 0"></span>
                                                            <span>communes</span>
                                                        </div>
                                                        <div class="stat">
                                                            <i class="fas fa-home"></i>
                                                            <span x-text="result.childrenCount.fokontany || 0"></span>
                                                            <span>fokontany</span>
                                                        </div>
                                                    </div>
                                                </template>

                                                <template x-if="result?.type === 'commune'">
                                                    <div class="stats-grid">
                                                        <div class="stat">
                                                            <i class="fas fa-home"></i>
                                                            <span x-text="result.childrenCount.fokontany || 0"></span>
                                                            <span>fokontany</span>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                            <div x-show="result.exactMatch" class="exact-match-indicator">
                                                <i class="fas fa-check-circle"></i>
                                                Exact match
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- No Results Found -->
                        <div x-show="hierarchicalSearchTerm && hierarchicalSearchTerm.length >= 2 && hierarchicalSearchResults.results.length === 0"
                            class="no-results">
                            <div class="no-results-content">
                                <i class="fas fa-search"></i>
                                <h3>No results found for "<span x-text="hierarchicalSearchTerm"></span>"</h3>
                                <p>Try adjusting your search terms or check the spelling</p>
                                <div class="no-results-suggestions">
                                    <p>Suggestions:</p>
                                    <ul>
                                        <li>Try a different spelling or abbreviation</li>
                                        <li>Search by partial name</li>
                                        <li>Check the filters to ensure you're searching all types</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w3-row w3-animate-right" id="searchSlide">
            <!-- Selected Result Details Panel -->
            <div x-show="selectedHierarchicalResult" class="hierarchy-details-panel">
                <div class="details-header">
                    <button class="back-button" @click="selectedHierarchicalResult = null; searchSlide.previous()">
                        <i class="fas fa-arrow-left"></i>
                        Back to results
                    </button>
                    <div class="details-title">
                        <div class="type-badge" :class="selectedHierarchicalResult?.type + '-badge'"
                            x-text="selectedHierarchicalResult?.type.toUpperCase()"></div>
                        <h2 x-text="selectedHierarchicalResult?.name"></h2>
                    </div>
                </div>

                <div class="details-content">
                    <!-- Hierarchical Path Breadcrumbs -->
                    <div class="hierarchy-path">
                        <div class="path-item" @click="selectHierarchicalResult(hierarchicalSearchResults.results[0])">
                            <i class="fas fa-globe-africa"></i>
                            <span>Madagascar</span>
                        </div>
                        <template x-for="(parent, index) in selectedHierarchicalResult?.hierarchyPath" :key="index">
                            <div class="path-separator">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <div class="path-item" @click="findAndSelectParent(parent)">
                                <i :class="getLevelIcon(parent.type)"></i>
                                <span x-text="parent?.name"></span>
                            </div>
                        </template>
                        <div class="path-separator">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="path-item active">
                            <i :class="getLevelIcon(selectedHierarchicalResult?.type)"></i>
                            <span x-text="selectedHierarchicalResult?.name"></span>
                        </div>
                    </div>

                    <!-- Complete Hierarchy Tree -->
                    <div class="hierarchy-tree">
                        <h3><i class="fas fa-sitemap"></i> Complete Administrative Structure</h3>

                        <div class="tree-container">
                            <!-- This would be dynamically generated based on the selected result -->
                            <div class="tree-item tree-root">
                                <div class="tree-node" :class="selectedHierarchicalResult?.type">
                                    <div class="tree-node-header">
                                        <div class="tree-node-type"
                                            x-text="selectedHierarchicalResult?.type.toUpperCase()">
                                        </div>
                                        <div class="tree-node-name" x-text="selectedHierarchicalResult?.name"></div>
                                        <div class="tree-node-stats">
                                            <template x-if="selectedHierarchicalResult?.type === 'region'">
                                                <span
                                                    x-text="selectedHierarchicalResult.childrenCount.districts + ' districts'"></span>
                                            </template>
                                            <template x-if="selectedHierarchicalResult?.type === 'district'">
                                                <span
                                                    x-text="selectedHierarchicalResult.childrenCount.communes + ' communes'"></span>
                                            </template>
                                            <template x-if="selectedHierarchicalResult?.type === 'commune'">
                                                <span
                                                    x-text="selectedHierarchicalResult.childrenCount.fokontany + ' fokontany'"></span>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Children would be dynamically loaded here -->
                                    <div class="tree-children"
                                        x-show="selectedHierarchicalResult?.children && selectedHierarchicalResult?.children.length > 0">
                                        <template
                                            x-for="(child, index) in selectedHierarchicalResult?.children.slice(0, 5)"
                                            :key="index">
                                            <div class="tree-child">
                                                <div class="tree-node">
                                                    <div class="tree-node-header">
                                                        <div class="tree-node-type"
                                                            x-text="getChildType(selectedHierarchicalResult?.type).toUpperCase()">
                                                        </div>
                                                        <div class="tree-node-name" x-text="child?.name"></div>
                                                        <div class="tree-node-stats">
                                                            <span
                                                                x-text="getChildCount(child, getChildType(selectedHierarchicalResult?.type))"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <div x-show="selectedHierarchicalResult?.children.length > 5" class="show-more">
                                            <button @click="loadAllChildren(selectedHierarchicalResult)">
                                                Show all <span
                                                    x-text="selectedHierarchicalResult?.children.length - 5"></span>
                                                more...
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        <div class="actions-grid">
                            <button class="action-btn" @click="viewOnMap(selectedHierarchicalResult)">
                                <i class="fas fa-map-marked-alt"></i>
                                <span>Show on Map</span>
                            </button>
                            <button class="action-btn" @click="viewStatistics(selectedHierarchicalResult)">
                                <i class="fas fa-chart-bar"></i>
                                <span>View Statistics</span>
                            </button>
                            <button class="action-btn" @click="copyHierarchy(selectedHierarchicalResult)">
                                <i class="fas fa-copy"></i>
                                <span>Copy Hierarchy</span>
                            </button>
                            <button class="action-btn" @click="compareWithOther(selectedHierarchicalResult)">
                                <i class="fas fa-balance-scale"></i>
                                <span>Compare</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>